<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	
	<title>NYC Pre-K Finder - Get in Touch</title>

	<link rel="stylesheet" href="//code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.css">
	
	<style type="text/css">
		body, label, span, div{
			color: #013364 !important;
		}
		body.loading{
			background-image:url(https://maps.nyc.gov/upk/img/spin.gif);
			background-position:center;
			background-repeat:no-repeat;
		}
		.loading div, .loading span, .loading h1, .loading h2, .loading h3, .loading input, .loading select{
			visibility:hidden;
		}
		h2, h3{
			color: #5681ac;
		}
		form {
			margin: 0 auto 100px;
			max-width: 600px;
		}
		.sect{
			border:1px solid #5681ac;
			border-radius:0.6em;
			padding:5px;
			margin:0 0 10px 0;
		}
		.ui-selectmenu-button{
			width:100% !important;
		}
		.err{
			color:red !important;
			font-weight:bold !important;
		}
		#review{
			margin: 12px calc(50% - 135px);
			width: 270px;
			border-radius: 0.6em;
			border: 1px solid lightgrey;
			box-shadow: 0 1px 3px rgba(0,0,0,0.5);
			background-color: white;
			padding: 5px;
			display:none;
		}
		.ui-btn.ui-corner-all, .ui-corner-all{
			border-radius: 0.6em;
		}
		#review h3{
			text-align:center;
		}
		.name{
			font-weight:bold;
		}
		#reviewBtns{
			width:207px;
			margin:20px 29px;
		}
		#thanks{
			margin: 20px auto;
			width: 270px;
		}
		#req_note{
			text-align: center;
		}
		table.fields{
			width: 100%;
			border-collapse: collapse;
		}
		.fields td{
			vertical-align: top;
			width: 50%;
		}
		#house_cell{
			width: 60px;
		}
		#apt_cell{
			width: 50px;
		}
		#borough_cell{
			width: 70%;
		}
		#zip_cell{
			width: 30%;
		}
		@media only screen and (max-width : 360px) {
			#house_cell{
				width: 60px;
			}
			#apt_cell{
				width: 30px;
			}		
		}
	</style>
	
	<script type="text/javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="//code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.js"></script>
	
	<script type="text/javascript" src="date_rules.js"></script>
	
	<script type="text/javascript">
		window.ios = navigator.userAgent.match(/(iPad|iPhone|iPod|iOS)/g) ? true : false;
		
		/* Set all global date strings and date-like strings */
		(function(){
			
			var pad = function(number){
				return number < 10 ? "0" + number : number + "";
			};
			
			var DEFAULT_DATES = {
				TODAY: new Date(),
				MIN_DOB: "2010-01-01",
				MAX_DOB: (function(){
					var today = new Date();
					return today.getFullYear() + "-" +
						pad(today.getMonth() + 1) + "-" +
						pad(today.getDate());
				}()),
				DEFAULT_DOB_ENTRY: "2011-01-01",
				PRE_K_REQUIRED_DOB_YEAR: "2011",
				SCHOOL_YEAR: "2015-16"
			};
							
			var validDateString = function(dateVarName){
				var invalidDateProvided = true;
				if (window[dateVarName]){
					try{
						var dateTyr = new Date(window[dateVarName]);
						invalidDateProvided = !isNaN(dateTyr.getFullYear());
					}catch(ignore){
						invalidDateProvided = true;
					}
				}
				return invalidDateProvided ? DEFAULT_DATES[dateVarName] : window[dateVarName];
			};

			window.TODAY = DEFAULT_DATES.TODAY;
			window.MIN_DOB = validDateString("MIN_DOB");
			window.MAX_DOB = validDateString("MAX_DOB");
			window.DEFAULT_DOB_ENTRY = validDateString("DEFAULT_DOB_ENTRY");
			window.PRE_K_REQUIRED_DOB_YEAR = window.PRE_K_REQUIRED_DOB_YEAR || DEFAULT_DATES.PRE_K_REQUIRED_DOB_YEAR;
			window.SCHOOL_YEAR = window.SCHOOL_YEAR || DEFAULT_DATES.SCHOOL_YEAR;

		}());
		
		$("document").ready(function(){		
			try{ /parse query string and prepopulate form */
				var params = document.location.search.substr(1).split("&");
				for (var i = 0; i < params.length; i++){
					var p = params[i].split("=");
					if (p[1]) $("#" + p[0]).val(decodeURIComponent(p[1]));			
				}
				$("#borough").selectmenu("refresh");
			}catch(ignore){}
			$("#applyNow").click(valid);
			$("select").on("change",function(e){$(e.target).focus();});
			
			$("#school_yr").html(SCHOOL_YEAR);
			$("#birth_yr").html(PRE_K_REQUIRED_DOB_YEAR);
			$("#dob").attr("min", MIN_DOB);
			$("#dob").attr("max", MAX_DOB);
		});

		function valid(){
			var err = [];
			$("label").removeClass("err");
			$.each($("input, select"), function(_, n){
				if ($(n).prop("required")){
					var val = $(n).val(), pattern = $(n).attr("pattern") || $(n).data("pattern"), valid = val.length;
					if (n.id == "dob"){
						var dob = new Date(getIsoDob());
						valid = dob >= new Date(MIN_DOB) && dob <= new Date(MAX_DOB);
					}else{
						if (valid && pattern){
							var regex = new RegExp(pattern);
							valid = regex.test(val);
						}						
					}
					if (!valid){
						err.push(n);
						$("label[for='" + n.id + "']").addClass("err");												
					}
				}
			});
			if (err.length){
				$(err[0]).focus();
			}else{
				review();
			}
		};	
	
		function review(){
			if (window.ios){
				iosReview();
			}else{
				var data = formData();
				for (var d in data){
					$("#review_" + d).html(data[d].toString());
				}
				$("form").fadeOut();
				$("#review").fadeIn();
			}
		};
		
		function iosReview(){
			var data = formData(),
				msg = "Please review your submission:\n\n" +
					"Date of birth: " + data.dob + "\n" +
					"Student address: " + "\n" +
					data.house_number + " " + data.street_name + " " + data.apt + "\n" +
					+ data.borough + ", NY " +  data.zip + "\n" +
					"Parent/Guardian name: " + data.parent_first_name + " " + data.parent_last_name + "\n" +
					"Day Telephone: " + data.day_telephone + "\n" +
					"Evening Telephone: " + data.evening_telephone + "\n" +
					"Email address: " + data.email + "\n";
			$("form").hide();
			if (confirm(msg)){
				apply();
			}else{
				$("form").fadeIn();
			}
		};
		
		function getDoeDob(){
			var dob = $("#dob").val();
			if (dob.indexOf("/") > -1){
				return dob;
			}else{
				dob = dob.split("-");
				return dob[1] + "/" + dob[2] + "/" + dob[0];				
			}
		};
		
		function getIsoDob(){
			var dob = $("#dob").val();
			if (dob.indexOf("-") > -1){
				return dob;
			}else{
				dob = dob.split("/");
				if (dob[0].length == 2 && 
						dob[1].length == 2 && 
						dob[2].length == 4 &&
						(dob[0] * 1) > 0 && (dob[0] * 1) < 13 &&
						(dob[1] * 1) > 0 && (dob[1] * 1) < 32
						){
					return dob[2] + "-" + dob[0] + "-" + dob[1];				
				}
				return "invalid";				
			}
		};
		
		function formData(){
			var result = {};
			result.dob = getDoeDob();
			result.house_number = $("#house_number").val();
			result.street_name = $("#street_name").val();
			result.apt = $("#apt").val();
			result.borough = $("#borough").val();
			result.zip = $("#zip").val();
			result.parent_first_name = $("#parent_first_name").val();
			result.parent_last_name = $("#parent_last_name").val();
			result.relationship = $("#relationship").val();
			result.day_telephone = $("#day_telephone").val();
			result.evening_telephone = $("#evening_telephone").val();
			result.email = $("#email").val();
			return result;
		};
		
		function apply(){
			var data = {id:0, method:"apply", jsonrpc:"2.0", params:{action:"apply", formfields:formData()}};
			$("body").addClass("loading");
			$.ajax({
				url:"./services/SchoolRpc.ashx?rpc",
				beforeSend: function(request){
					request.setRequestHeader("Content-Type", "application/json; charset-utf-8");
				},
				method:"POST",
				dataType:"json",
				data:JSON.stringify(data),
				success: function(response){
					if (!response.result || (!response.result.ApplicationSubmitFlag && !response.result.EmailSentFlag)){
						this.error();
						return;
					}
					if (window.ios){
						alert("Thank you for completing our Pre-K for All information form!  Your submission is being sent to the Pre-K for All Outreach team, who will contact you soon.   You will also receive an email shortly confirming your submission.");
					}else{
						$("#result").html("<div id='thanks'>Thank you for completing our Pre-K for All information form!  Your submission is being sent to the Pre-K for All Outreach team, who will contact you soon.   You will also receive an email shortly confirming your submission.</div>");
						$("#review").fadeOut();
						$("#result").fadeIn();
					}
					$("body").removeClass("loading");
				},
				error: function(){
					$("body").removeClass("loading");
					alert("There was an error processing your submission data.  Please try again.");
					$("#review").fadeOut();
					$("form").fadeIn();
				}
			});
			return false;
		};
	</script>
</head>
<body>
	<div id="page" data-role="page">
		<div id="main" role="main" class="ui-content">
			<form autocomplete="on" novalidate>
				<div class="sect">
					<h2>Student Information</h2>
					<label for="dob">Date of birth (mm/dd/yyyy):</label>
					<input id="dob" name="dob" type="date" required maxlength="10">
					(Note: To be eligible for pre-K for the <span id="school_yr"></span> school year, your child must have been born in the year <span id="birth_yr"></span>.)
					<h3>Current address</h3>
					<table class="fields">
						<tbody>
							<tr>
								<td id="house_cell">
									<label for="house_number">House no:</label>
									<input id="house_number" name="house_number" type="text" required placeholder="52">
								</td>
								<td>
									<label for="street_name">Street name:</label>
									<input id="street_name" name="street_name" type="text" required placeholder="Chambers St">
								</td>
								<td id="apt_cell">
									<label for="apt">Apt:</label>
									<input id="apt" name="apt" type="text" placeholder="1A">					
								</td>
							</tr>
						</tbody>
					</table>	
					<table class="fields">
						<tbody>
							<tr>
								<td id="borough_cell">
									<label for="borough">Borough:</label>
									<select id="borough" name="borough" required data-pattern="^((?!Choose).)*$">
										<option>Choose...</option>
										<option>Bronx</option>
										<option>Brooklyn</option>
										<option>Manhattan</option>
										<option>Queens</option>
										<option>Staten Island</option>
									</select>
								</td>
								<td id="zip_cell">		
									<label for="zip">ZIP Code:</label>
									<input id="zip" name="zip" type="text" maxlength="5" required pattern="^\d{5}$" placeholder="12345">
								</td>
							</tr>
						</tbody>
					</table>
				</div>					
				<div class="sect">
					<h2>Parent/Guardian Information</h2>
					<table class="fields">
						<tbody>
							<tr>
								<td>
									<label for="parent_first_name">First name:</label>
									<input id="parent_first_name" name="parent_first_name" type="text" required>
								</td>
								<td>
									<label for="parent_last_name">Last name:</label>
									<input id="parent_last_name" name="parent_last_name" type="text" required>
								</td>
							</tr>
						</tbody>
					</table>
					<label for="relationship">Relationship:</label>
					<select id="relationship" name="relationship" required data-pattern="^((?!Choose).)*$">
						<option>Choose...</option>
						<option>Mother</option>
						<option>Father</option>
						<option>Grandparent</option>
						<option>Sister/Brother</option>
						<option>Other Relative</option>
						<option>Step Parent</option>
						<option>Foster Parent</option>
						<option>Agency</option>
						<option>Ward Of State</option>
						<option>Other Legal Guardian</option>
						<option>Non-Relative</option>
					</select>
					<h3>Contact Information</h3>
					<table class="fields">
						<tbody>
							<tr>
								<td>
									<label for="day_telephone">Day phone:</label>
									<input id="day_telephone" name="day_telephone" type="text" maxlength="10" required pattern="[0-9]{10}" placeholder="2125555555">
								</td>
								<td>	
									<label for="evening_telephone">Evening phone:</label>
									<input id="evening_telephone" name="evening_telephone" maxlength="10" type="text" required pattern="[0-9]{10}" placeholder="2125555555">
								</td>
							</tr>
						</tbody>
					</table>
					<label for="email">Email address:</label>
					<input id="email" name="email" type="text" required pattern="[\w-]+@([\w-]+\.)+[\w-]+">
				</div>
				<input id="applyNow" type="button" value="Submit Info">
			</form>
			<div id="review">		
				<h3>Please review your submission:</h3>
				<div>
					<span class="name">Date of birth:</span><br><span id="review_dob"></span><br>
				</div>
				<div>
					<span class="name">Current address:</span><br><span id="review_house_number"></span> <span id="review_street_name"></span> <span id="review_apt"></span><br>
					<span id="review_borough"></span>, NY <span id="review_zip"></span>
				</div>
				<div><span class="name">Parent/Guardian name:</span><br><span id="review_parent_first_name"></span> <span id="review_parent_last_name"></span></div>
				<div><span class="name">Relationship:</span> <span id="review_relationship"></span></div>
				<div><span class="name">Day Telephone:</span> <span id="review_day_telephone"></span></div>
				<div><span class="name">Evening Telephone:</span> <span id="review_evening_telephone"></span></div>
				<div><span class="name">Email address:</span> <span id="review_email"></span></div>
				<div id="reviewBtns">
					<input type="button" onclick="$('#review').fadeOut();$('form').fadeIn();" value="Cancel">
					<input type="button" onclick="apply();" value="Submit">
				</div>
			</div>
			<div id="result">
			
			</div>
		</div>
	</div>
	<script>
		/google analytics */
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		
		ga('create', 'UA-41281554-9', 'auto');
		ga('send', 'pageview');
	</script>	
</body>
</html>